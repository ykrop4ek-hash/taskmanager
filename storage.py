
"""
–ú–æ–¥—É–ª—å storage ‚Äî –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PostgreSQL, —Å–æ—Ö—Ä–∞–Ω—è—é—â–∏–π –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
—Å–æ —Å—Ç–∞—Ä—ã–º JSON-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.
"""

from models import Task
import sys
import os

# –î–ª—è –∏–º–ø–æ—Ä—Ç–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ—Å—Ç–∞—Ö)
FILE_PATH = "tasks.json"  # –û—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –ë–î


class TaskRepository:
    """–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–¥–∞—á–∞–º–∏ –≤ PostgreSQL"""

    @staticmethod
    def load_tasks(filters=None):
        """
        –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

        Args:
            filters (dict, optional): –°–ª–æ–≤–∞—Ä—å —Ñ–∏–ª—å—Ç—Ä–æ–≤.
                –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å: status, priority, due_date

        Returns:
            list[Task]: —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ Task.
        """
        return Task.get_all(filters)

    @staticmethod
    def save_tasks(tasks):
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
        –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.

        Args:
            tasks (list[Task]): —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á.
        """
        for task in tasks:
            task.save()

    @staticmethod
    def add_task(task):
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

        Args:
            task (Task): –æ–±—ä–µ–∫—Ç –∑–∞–¥–∞—á–∏.

        Returns:
            Task: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ (—Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ created_at, updated_at).
        """
        return task.save()

    # storage.py - –¥–æ–±–∞–≤—å—Ç–µ –≤ –∫–ª–∞—Å—Å TaskRepository

    @staticmethod
    def mark_done_by_short_id(short_id):
        """–û—Ç–º–µ—á–∞–µ—Ç –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é –ø–æ –∫–æ—Ä–æ—Ç–∫–æ–º—É ID"""
        return Task.mark_done_by_short_id(short_id)

    # –ò –æ–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é mark_done
    def mark_done(task_id):
        """
        –û—Ç–º–µ—á–∞–µ—Ç –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é.
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø ID.
        """
        # –ï—Å–ª–∏ ID –∫–æ—Ä–æ—Ç–∫–∏–π (–º–µ–Ω–µ–µ 36 —Å–∏–º–≤–æ–ª–æ–≤) - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
        if len(task_id) < 36:
            print(f"üîç –ò—â—É –∑–∞–¥–∞—á—É —Å ID, –Ω–∞—á–∏–Ω–∞—é—â–∏–º—Å—è –Ω–∞ '{task_id}'...")
            return repository.mark_done_by_short_id(task_id)
        else:
            # –ï—Å–ª–∏ ID –¥–ª–∏–Ω–Ω—ã–π - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—ã–π –ø–æ–∏—Å–∫
            return repository.mark_done(task_id)

    @staticmethod
    def delete_task(task_id):
        """
        –£–¥–∞–ª—è–µ—Ç –∑–∞–¥–∞—á—É –ø–æ ID.

        Args:
            task_id (str): –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞—á–∏.

        Returns:
            bool: True –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞, False –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.
        """
        return Task.delete_by_id(task_id)

    @staticmethod
    def mark_done(task_id):
        """
        –û—Ç–º–µ—á–∞–µ—Ç –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é.

        Args:
            task_id (str): –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞—á–∏.

        Returns:
            bool: True –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞, False –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.
        """
        print(f"[DEBUG] storage.mark_done –ø–æ–ª—É—á–∏–ª: task_id={task_id}, type={type(task_id)}")
        return Task.mark_done_by_id(task_id)


# –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
repository = TaskRepository()


# ============================================================================
# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
# –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–µ—é—Ç –¢–û–ß–ù–û —Ç–∞–∫–∏–µ –∂–µ –∏–º–µ–Ω–∞, –∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º storage.py
# ============================================================================

def load_tasks(filters=None):
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.

    Args:
        filters (dict, optional): –°–ª–æ–≤–∞—Ä—å —Ñ–∏–ª—å—Ç—Ä–æ–≤.

    Returns:
        list[Task]: —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ Task.
    """
    return repository.load_tasks(filters)


def save_tasks(tasks):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
    –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.

    Args:
        tasks (list[Task]): —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á.
    """
    repository.save_tasks(tasks)


def add_task(task):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
    –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.

    Args:
        task (Task): –æ–±—ä–µ–∫—Ç –∑–∞–¥–∞—á–∏.
    """
    repository.add_task(task)


def delete_task(task_id):
    """
    –£–¥–∞–ª—è–µ—Ç –∑–∞–¥–∞—á—É –ø–æ ID.
    –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.

    Args:
        task_id (str): –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞—á–∏.
    """
    repository.delete_task(task_id)


def mark_done(task_id):
    """
    –û—Ç–º–µ—á–∞–µ—Ç –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é.
    –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.

    Args:
        task_id (str): –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞—á–∏.
    """
    repository.mark_done(task_id)


# ============================================================================
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
# ============================================================================

def set_file_path(file_path):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ç–µ—Å—Ç–∞–º–∏).
    –í PostgreSQL —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç, –Ω–æ –Ω—É–∂–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤.

    Args:
        file_path (str): –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –ë–î).
    """
    global FILE_PATH
    FILE_PATH = file_path